---
version: '3.7'
services:

########################################################################################
# oauth2
# https://quay.io/repository/pusher/oauth2_proxy
# https://github.com/pusher/oauth2_proxy
# https://github.com/pusher/oauth2_proxy/issues/46
########################################################################################

  oauth2:
    container_name: oauth2
    image: quay.io/oauth2-proxy/oauth2-proxy:latest-arm64
    command:
      - "--cookie-domain=${FQDN}"
      - "--cookie-secure=true"
      - "--email-domain=*"
      - "--github-user=${GITHUB_USER}" # allow logins by username, separated by a comma
      - "--http-address=0.0.0.0:4180"
      - "--pass-access-token"
      - "--provider=github"
      - "--redirect-url=https://${FQDN}/oauth2/callback"
      - "--set-authorization-header"
      - "--set-xauthrequest"
      - "--whitelist-domain=.${FQDN}"
    environment:
      - "OAUTH2_PROXY_CLIENT_ID=${GITHUB_OAUTH_CLIENT_ID}"
      - "OAUTH2_PROXY_CLIENT_SECRET=${GITHUB_OAUTH_CLIENT_SECRET}"
      - "OAUTH2_PROXY_COOKIE_SECRET=${OAUTH2_PROXY_COOKIE_SECRET}"
    expose:
      - "4180"
    #ports:
      #- 4180:4180
    labels:
      - "traefik.enable=true"
      ## HTTP Routers
      - "traefik.http.routers.oauth2-rtr.entrypoints=websecure"
      # - "traefik.http.routers.oauth2-rtr.rule=Host(`oauth2.${FQDN}`)"
      - "traefik.http.routers.oauth2-rtr.rule=Host(`${FQDN}`); PathPrefixStrip: /oauth2"
      # - "traefik.http.routers.oauth2-rtr.rule=Host(`oauth2.${FQDN?err}`) || PathPrefix(`/oauth2`)"
      - "traefik.http.routers.oauth2-rtr.tls=true"
      ## Middlewares
      - "traefik.http.routers.oauth2-rtr.middlewares=chain-oauth2@file"
      ## HTTP Services
      - "traefik.http.routers.oauth2-rtr.service=oauth2-svc"
      - "traefik.http.services.oauth2-svc.loadbalancer.server.port=4180"
      ## Other labels
      # - "traefik.http.middlewares.oauth2-verify.forwardAuth.address=http://oauth2:4180/oauth2/auth"
      # - "traefik.http.middlewares.oauth2-verify.forwardAuth.trustForwardHeader=true"
      # - "traefik.http.middlewares.oauth2-verify.forwardAuth.authResponseHeaders=X-Auth-Request-User,X-Auth-Request-Email,Set-Cookie"
      # - "traefik.http.middlewares.oauth2-signin.errors.service=oauth2@file"
      # - "traefik.http.middlewares.oauth2-signin.errors.status=401"
      # - "traefik.http.middlewares.oauth2-signin.errors.query=/oauth2/sign_in"
      # - "traefik.http.routers.oauth2.entrypoints=websecure"
      # - "traefik.http.routers.oauth2.tls.certResolver=default"
      # - "traefik.http.routers.oauth2.service=oauth2@file"
      # - "traefik.http.services.oauth2.loadbalancer.server.port=4180"
    networks:
      - backend
    restart: unless-stopped

networks:
  backend:
    external:
      name: backend
      #run: docker network create backend